<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>N√∂v√©nyfigyel≈ë</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0;}
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f0f7f3 0%, #e0f2f1 100%);
      overflow-x: hidden;
      color: #1b3a2a;
      text-align: center;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 2.8em;
      margin: 25px 0;
      color: #0d3b23;
      letter-spacing: 1px;
      text-shadow: 1px 1px 5px rgba(0,0,0,0.05);
    }
    .card {
      position: relative;
      background: rgba(255,255,255,0.9);
      border-radius: 30px;
      padding: 30px 25px;
      margin: 25px auto;
      max-width: 420px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.35s ease, box-shadow 0.35s ease;
    }
    .card::before, .card::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      opacity: 0.1;
      animation: float 12s infinite linear;
    }
    .card::before {
      width: 200px; height: 200px;
      background: #66bb6a;
      top: -50px; right: -80px;
    }
    .card::after {
      width: 150px; height: 150px;
      background: #43a047;
      bottom: -60px; left: -50px;
      animation-duration: 16s;
    }
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg);}
      50% { transform: translateY(-20px) rotate(180deg);}
      100% { transform: translateY(0) rotate(360deg);}
    }
    .card:hover { transform: translateY(-8px); box-shadow: 0 28px 48px rgba(0,0,0,0.15);}
    input, select, button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
    }
    input { background: #f0f7f3;}
    input:focus { box-shadow: 0 0 0 4px rgba(102,187,106,0.25);}
    select {
      background: #f0f7f3;
      padding-right: 40px;
      cursor: pointer;
    }
    button {
      background: linear-gradient(145deg, #66bb6a, #43a047);
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    button:hover {
      background: linear-gradient(145deg, #43a047, #66bb6a);
      transform: scale(1.03);
    }
    #logout { background: #ef5350;}
    #logout:hover { background: #d32f2f;}
    .gauge-container {
      position: relative;
      width: 220px;
      height: 220px;
      margin: 30px auto;
    }
    @media (max-width: 480px) {
      .gauge-container { width: 180px; height: 180px;}
    }
    .gauge-svg { transform: rotate(-90deg); width:100%; height:100%;}
    .gauge-bg { fill: none; stroke: #c8e6c9; stroke-width: 18;}
    .gauge-fill { fill: none; stroke-width: 18; stroke-linecap: round; transition: stroke-dashoffset 0.6s ease, stroke 0.4s ease;}
    .gauge-value {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      font-size: 32px;
      font-weight: bold;
      color: #1b3a2a;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.05);
      line-height: 1;
      white-space: nowrap;
    }
    @media (max-width: 480px) {
      .gauge-value { font-size: 24px;}
    }
    #addAccountBtn {
      position: fixed;
      bottom: 25px; right: 25px;
      width: 65px; height: 65px;
      background: linear-gradient(145deg, #43a047, #66bb6a);
      border-radius: 50%;
      color: white; font-size: 38px; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 22px rgba(0,0,0,0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      z-index: 1000;
    }
    #addAccountBtn:hover { transform: scale(1.1); box-shadow: 0 8px 28px rgba(0,0,0,0.25);}
    #notifBellBtn {
      position: fixed;
      bottom: 115px; right: 25px;
      width: 65px; height: 65px;
      background: linear-gradient(145deg, #43a047, #66bb6a);
      border-radius: 50%;
      color: white; font-size: 34px; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 22px rgba(0,0,0,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
      z-index: 1001;
    }
    #notifBellBtn.inactive {
      background: linear-gradient(145deg, #b0c4b1, #d0e6cd);
      color: #7e917c;
    }
    #notifBellBtn:hover { transform: scale(1.08);}
    .deleteBtn {
      position: absolute;
      top: 18px; right: 18px;
      width: 40px; height: 40px;
      background: #fff; border: none; border-radius: 50%;
      box-shadow: 0 2px 10px rgba(220,0,60,0.10),0 1.5px 4px rgba(0,0,0,0.09);
      color: #d32f2f;
      font-weight: bold;
      font-size: 26px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: background 0.22s, color 0.22s, transform 0.14s;
      z-index: 5;
    }
    .deleteBtn:hover {
      background: #ffe3e3;
      color: #b71c1c;
      transform: scale(1.125);
      box-shadow: 0 6px 16px rgba(220,0,60,0.19);
    }
    #modal, #confirmModal {
      display: none;
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.45);
      justify-content: center; align-items: center; z-index: 1100;
    }
    #modalContent, #confirmModalContent {
      background: #ffffffee; padding: 36px 28px;
      border-radius: 28px; box-shadow: 0 20px 48px rgba(0,0,0,0.2);
      width: 380px; max-width: 92vw; text-align: center; position: relative;
      animation: popIn 0.3s ease-out;
    }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0;} to { transform: scale(1); opacity: 1;} }
    #modalClose, #confirmClose {
      position: absolute; top: 18px; right: 20px;
      font-size: 28px; color: #aaa; cursor: pointer; transition: color 0.25s ease;
    }
    #modalClose:hover, #confirmClose:hover { color: #111;}
    label { font-weight: 600; color: #1b3a2a; margin-bottom: 6px; display: block;}
    .led-slider {
      width: 92%; margin: 14px auto; display: block;
      appearance: none; height: 18px; border-radius: 12px;
      background: linear-gradient(90deg, #e7ffe0 0%, #4caf50 100%);
      outline: none; transition: all 0.25s ease;
    }
    .led-slider::-webkit-slider-thumb {
      appearance: none; width: 28px; height: 28px; border-radius: 50%;
      background: #66bb6a; border: 3px solid #fff; cursor: pointer;
      box-shadow: 0 4px 12px rgba(76,175,80,0.2); transition: transform 0.25s ease;
    }
    .led-slider::-webkit-slider-thumb:hover { transform: scale(1.1);}
    @media (max-width: 480px) {
      h1 { font-size: 2.2em; margin: 20px 0;}
      .card { margin: 20px 10px; padding: 25px;}
      .gauge-container { width: 180px; height: 180px;}
      #notifBellBtn, #addAccountBtn { width: 46px; height: 46px; font-size: 22px;}
      #notifModalContent { padding: 22px 8px;}
    }
    #notifModal {
      display: none;
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.45);
      justify-content: center; align-items: center; z-index: 1101;
    }
    #notifModalContent {
      background: #fff; padding: 34px 23px;
      border-radius: 28px; box-shadow: 0 20px 48px rgba(0,0,0,0.2);
      width: 360px; max-width: 90vw; text-align: center; position: relative;
      animation: popIn 0.3s ease-out;
    }
    #notifModalClose {
      position: absolute; top: 18px; right: 20px;
      font-size: 28px; color: #aaa; cursor: pointer; transition: color 0.22s;
    }
    #notifModalClose:hover { color: #111;}
  </style>
  
  


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfo3UqEb77ihYOqSJZvIFVr2VRGf6dJ4w",
      authDomain: "plant-monitor-3976f.firebaseapp.com",
      databaseURL: "https://plant-monitor-3976f-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "plant-monitor-3976f",
      storageBucket: "plant-monitor-3976f.appspot.com",
      messagingSenderId: "705425147510",
      appId: "1:705425147510:web:71f15bde879f3672df8157",
      measurementId: "G-890H6FDBYE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const accounts = new Map();
    const STORAGE_KEY = 'storedAccounts';
    const PLANT_TYPE_KEY = 'plantTypeData_hu_v1';

    function getStoredAccounts() {
      try { const data = localStorage.getItem(STORAGE_KEY); return data ? JSON.parse(data) : []; } catch { return []; }
    }
    function setStoredAccounts(accs) { localStorage.setItem(STORAGE_KEY, JSON.stringify(accs)); }
    function addStoredAccount(email, uid) {
      const accs = getStoredAccounts();
      if (!accs.some(a => a.uid === uid)) { accs.push({ email, uid }); setStoredAccounts(accs); }
    }
    function removeStoredAccount(uid) {
      const accs = getStoredAccounts().filter(a => a.uid !== uid);
      setStoredAccounts(accs);
      const plantTypesDict = getPlantTypeAll();
      delete plantTypesDict[uid];
      savePlantTypeAll(plantTypesDict);
    }
    function getPlantTypeAll() {
      try { const d = localStorage.getItem(PLANT_TYPE_KEY); return d ? JSON.parse(d) : {}; } catch { return {}; }
    }
    function savePlantTypeAll(obj) { localStorage.setItem(PLANT_TYPE_KEY, JSON.stringify(obj)); }
    function getPlantType(uid) {
      const d = getPlantTypeAll(); return d[uid] || '';
    }
    function setPlantType(uid, value) {
      const d = getPlantTypeAll(); d[uid] = value; savePlantTypeAll(d);
    }

    const loginForm = document.getElementById("loginForm");
    const emailInput = document.getElementById("email");
    const passInput = document.getElementById("password");
    const statusDiv = document.getElementById("status");
    const gaugeValue = document.getElementById("gauge-value");
    const gaugeCircle = document.querySelector(".gauge-fill");
    const logoutBtn = document.getElementById("logout");
    const plantDataCard = document.getElementById("plantData");
    const addAccountBtn = document.getElementById("addAccountBtn");
    const modal = document.getElementById("modal");
    const modalCloseBtn = document.getElementById("modalClose");
    const addNewAccountForm = document.getElementById("addNewAccountForm");
    const newAccountEmail = document.getElementById("newAccountEmail");
    const newAccountPass = document.getElementById("newAccountPass");
    const newAccountToken = document.getElementById("newAccountToken");
    const addAccountStatus = document.getElementById("addAccountStatus");
    const accountsContainer = document.getElementById("accountsContainer");

    const plantCategories = {
      "üåµSz√°razkedvel≈ë": { min: 10, max: 40 },
      "üåæM√©rs√©kelten sz√°raz": { min: 20, max: 45 },
      "üåøKiegyens√∫lyozott v√≠zig√©ny≈±": { min: 30, max: 60 },
      "üå±Nedvess√©gkedvel≈ë": { min: 50, max: 80 },
      "üíßV√≠zig√©nyes": { min: 70, max: 100 }
    };

    function normalizeToCategory(value, min, max) {
      let norm = (value - min) / (max - min);
      return Math.max(0, Math.min(1, norm));
    }

    const RADIUS = 90, CIRCUMFERENCE = 2 * Math.PI * RADIUS;
    gaugeCircle.style.strokeDasharray = CIRCUMFERENCE;

    let firstUser = null;

    window.addEventListener('load', () => {
      const stored = getStoredAccounts();
      if (stored.length > 0) {
        stored.forEach(acc => {
          addAccountCard({ uid: acc.uid }, acc.email, auth, false);
        });
        hideLoginScreen();
      } else {
        showLoginScreen();
      }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusDiv.style.color = "green";
      statusDiv.innerText = "Bejelentkez√©s...";

      try {
        const userCred = await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
        const user = userCred.user;

        if (accounts.has(user.uid)) {
          statusDiv.style.color = "red";
          statusDiv.innerText = "Ez a fi√≥k m√°r hozz√° van adva!";
          modal.style.display = "none";
          return;
        }

        addAccountCard(user, emailInput.value, auth, accounts.size === 0);
        addStoredAccount(emailInput.value, user.uid);
        hideLoginScreen();
      } catch (err) {
        statusDiv.style.color = "red";
        if (["auth/invalid-credential", "auth/wrong-password", "auth/user-not-found"].includes(err.code)) {
          statusDiv.innerText = "Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥!";
        } else {
          statusDiv.innerText = "Hiba: " + err.message;
        }
      }
    });

    logoutBtn.style.display = "none";
    logoutBtn.addEventListener("click", async () => {
      if (!firstUser) return;
      await signOut(auth);
      removeAccount(firstUser.uid);
      showLoginScreen();
    });

    function showLoginScreen() {
      loginForm.style.display = "block";
      statusDiv.style.display = "block";
      logoutBtn.style.display = "none";
      plantDataCard.style.display = "block";
      accountsContainer.style.display = "none";
      addAccountBtn.style.display = "none";
      updateGauge(0);
      firstUser = null;
    }

    function hideLoginScreen() {
      loginForm.style.display = "none";
      statusDiv.style.display = "none";
      logoutBtn.style.display = "none";
      plantDataCard.style.display = "none";
      accountsContainer.style.display = "block";
      addAccountBtn.style.display = "flex";
    }

    function updateGauge(value) {
      gaugeValue.innerText = value + "%";
      const offset = CIRCUMFERENCE - (value / 100) * CIRCUMFERENCE;
      gaugeCircle.style.strokeDashoffset = offset;
      const color = getGradientColor(value);
      gaugeCircle.style.stroke = color;
      gaugeValue.style.color = color;
    }

    function getGradientColor(value) {
      let r, g, b;
      if (value <= 50) {
        const ratio = value / 50;
        r = 255;
        g = Math.round(69 + (215 - 69) * ratio);
        b = 0;
      } else {
        const ratio = (value - 50) / 50;
        r = Math.round(255 + (76 - 255) * ratio);
        g = Math.round(215 + (175 - 215) * ratio);
        b = Math.round(0 + (80 - 0) * ratio);
      }
      return `rgb(${r},${g},${b})`;
    }

    addAccountBtn.addEventListener("click", () => {
      modal.style.display = "flex";
      addAccountStatus.innerText = "";
    });

    modalCloseBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });

    addNewAccountForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = newAccountEmail.value.trim();
      const pass = newAccountPass.value.trim();

      addAccountStatus.textContent = "";

      const stored = getStoredAccounts();
      if (stored.some(acc => acc.email === email)) {
        addAccountStatus.style.color = "red";
        addAccountStatus.textContent = "Ez a fi√≥k m√°r hozz√° van adva!";
        return;
      }

      try {
        const userCred = await signInWithEmailAndPassword(auth, email, pass);
        const uid = userCred.user.uid;

        addStoredAccount(email, uid);
        addAccountCard({ uid }, email, auth, true);

        modal.style.display = "none";
        newAccountEmail.value = "";
        newAccountPass.value = "";
        addAccountStatus.textContent = "";

      } catch (err) {
        addAccountStatus.style.color = "red";

        if (err.code === "auth/invalid-credential") {
          addAccountStatus.textContent = "Hib√°s email vagy jelsz√≥.";
        } else {
          addAccountStatus.textContent = "Hiba t√∂rt√©nt: " + err.message;
        }
      }
    });

    function removeAccount(uid) {
      if (accounts.has(uid)) {
        accounts.get(uid).card.remove();
        accounts.delete(uid);
      }
      removeStoredAccount(uid);
      if (accounts.size === 0) {
        showLoginScreen();
      }
    }

    let confirmResolve = null;
    function showConfirmModal(message) {
      return new Promise((resolve) => {
        const modal = document.getElementById("confirmModal");
        document.getElementById("confirmText").innerText = message;
        modal.style.display = "flex";
        confirmResolve = resolve;
      });
    }

    function hideConfirmModal() {
      const modal = document.getElementById("confirmModal");
      modal.style.display = "none";
      if (confirmResolve) confirmResolve(false);
      confirmResolve = null;
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("confirmIgenBtn").addEventListener("click", () => {
        const modal = document.getElementById("confirmModal");
        modal.style.display = "none";
        if (confirmResolve) confirmResolve(true);
        confirmResolve = null;
      });
      document.getElementById("confirmNemBtn").addEventListener("click", () => {
        hideConfirmModal();
      });
      document.getElementById("confirmClose").addEventListener("click", () => {
        hideConfirmModal();
      });
      window.addEventListener("keydown", (e) => {
        if(e.key === "Escape" && document.getElementById("confirmModal").style.display === "flex") {
          hideConfirmModal();
        }
      });
    });

    function addAccountCard(user, email, auth, isMain=false) {

      const plantTypes = [
        "üåµSz√°razkedvel≈ë",
        "üåæM√©rs√©kelten sz√°raz",
        "üåøKiegyens√∫lyozott v√≠zig√©ny≈±",
        "üå±Nedvess√©gkedvel≈ë",
        "üíßV√≠zig√©nyes"
      ];

      const card = document.createElement("div");
      card.className = "card accountCard";

      const selectId = `plantTypeSelect-${user.uid}`;
      const optionsHtml = plantTypes.map(typ =>
        `<option value="${typ}">${typ}</option>`
      ).join("");

      const plantTypeSelectHtml = `
        <div style="margin-top:20px; margin-bottom:15px;">
          <label for="${selectId}" class="plant-type-label">N√∂v√©ny t√≠pusa:</label>
          <div class="select-wrap">
            <select id="${selectId}" class="plant-type-select">
              <option value="">V√°lassz kateg√≥ri√°t</option>
              ${optionsHtml}
            </select>
          </div>
        </div>`;

      card.innerHTML = `
        <button class="deleteBtn" aria-label="Fi√≥k t√∂rl√©se">‚úñ</button>
        <h3>
          <span class="displayNameSpan">${email}</span>
          <button class="editNameBtn" aria-label="N√©v szerkeszt√©se" style="background:none;border:none;cursor:pointer;margin-left:3px;font-size:15px;">‚úèÔ∏è</button>
        </h3>
        <input type="text" class="editNameInput" style="display:none;width:75%;margin:0 auto 7px auto;padding:8px;" maxlength="50"/>
        <button class="saveNameBtn" style="display:none;background:#43a047;color:#fff;margin-bottom:10px;border-radius:9px;padding:8px 16px;border:none;font-size:15px;cursor:pointer;">Ment√©s</button>
        <div class="gauge-container">
          <svg class="gauge-svg" width="200" height="200" viewBox="0 0 200 200">
            <circle class="gauge-bg" cx="100" cy="100" r="80"></circle>
            <circle class="gauge-fill" cx="100" cy="100" r="80"></circle>
          </svg>
          <div class="gauge-value">0%</div>
        </div>
        <div class="slider-container" style="display:none;">
          <input type="range" min="0" max="100" step="1" value="0" class="led-slider" />
          <div class="slider-labels"><span>F√©ny er≈ë</span></div>
        </div>
        ${plantTypeSelectHtml}
      `;

      const gaugeValueEl = card.querySelector(".gauge-value");
      const gaugeCircleEl = card.querySelector(".gauge-fill");
      const displayNameSpan = card.querySelector(".displayNameSpan");
      const editBtn = card.querySelector(".editNameBtn");
      const editInput = card.querySelector(".editNameInput");
      const saveBtn = card.querySelector(".saveNameBtn");

      gaugeCircleEl.style.strokeDasharray = 2 * Math.PI * 80;

      let currPercent = 0;
      let currCat = "";
      let firstDeviceId = null;

      (async () => {
        if (user.uid) {
          const devicesSnap = await get(ref(db, `users/${user.uid}/devices`));
          if (devicesSnap.exists()) {
            const devicesData = devicesSnap.val();
            firstDeviceId = Object.keys(devicesData)[0];
            // <<< ADD HOZZ√Å EZT A SORT! >>>
            window.jelenlegiEszkozID = firstDeviceId;

            const nameSnap = await get(ref(db, `users/${user.uid}/devices/${firstDeviceId}/displayName`));
            if (nameSnap.exists() && nameSnap.val()) {
              displayNameSpan.textContent = nameSnap.val();
            }

            const catSnap = await get(ref(db, `users/${user.uid}/devices/${firstDeviceId}/plantType`));
            if (catSnap.exists() && catSnap.val()) {
              currCat = catSnap.val();
              const selectElem = card.querySelector(`#${selectId}`);
              selectElem.value = currCat;
              updateAccountGauge(currPercent, currCat);
            }

            const sliderContainer = card.querySelector('.slider-container');
            if (devicesData[firstDeviceId] && devicesData[firstDeviceId].hasOwnProperty('ledLevel')) {
              sliderContainer.style.display = "block";
              const slider = card.querySelector('.led-slider');
              const ledLevelRef = ref(db, `users/${user.uid}/devices/${firstDeviceId}/ledLevel`);
              onValue(ledLevelRef, (snap) => {
                if (snap.exists()) slider.value = snap.val();
              });
              slider.addEventListener('input', async (e) => {
                const newValue = parseInt(e.target.value);
                await set(ledLevelRef, newValue);
              });
            } else {
              sliderContainer.style.display = "none";
            }

            const soilRef = ref(db, `users/${user.uid}/devices/${firstDeviceId}/sensorValue`);
            onValue(soilRef, (snap) => {
              if (snap.exists()) {
                currPercent = snap.val();
                updateAccountGauge(currPercent, currCat);
              }
            });
          }
        }
      })();

      editBtn.addEventListener("click", () => {
        editInput.value = displayNameSpan.textContent;
        displayNameSpan.style.display = "none";
        editBtn.style.display = "none";
        editInput.style.display = "inline-block";
        saveBtn.style.display = "inline-block";
        editInput.focus();
      });

      saveBtn.addEventListener("click", async () => {
        const newName = editInput.value.trim();
        if (!newName) return;
        displayNameSpan.textContent = newName;
        displayNameSpan.style.display = "inline-block";
        editBtn.style.display = "inline-block";
        editInput.style.display = "none";
        saveBtn.style.display = "none";
        if (user.uid && firstDeviceId) {
          await set(ref(db, `users/${user.uid}/devices/${firstDeviceId}/displayName`), newName);
        }
      });

      function updateAccountGauge(realPercent, cat) {
        let display = 0;
        if (plantCategories[cat]) {
          const { min, max } = plantCategories[cat];
          display = Math.round(((realPercent - min) / (max - min)) * 100);
          if (display < 0) display = 0;
          if (display > 100) display = 100;
        } else {
          display = realPercent;
        }
        gaugeValueEl.innerText = display + "%";
        const offset = 2 * Math.PI * 80 - (display / 100) * 2 * Math.PI * 80;
        gaugeCircleEl.style.strokeDashoffset = offset;
        const color = getGradientColor(display);
        gaugeCircleEl.style.stroke = color;
        gaugeValueEl.style.color = color;
      }

      const selectElem = card.querySelector(`#${selectId}`);
      setTimeout(async () => {
        let saved = '';
        if (user.uid && firstDeviceId) {
          const catSnap = await get(ref(db, `users/${user.uid}/devices/${firstDeviceId}/plantType`));
          if (catSnap.exists() && catSnap.val()) {
            saved = catSnap.val();
          }
        }
        if (!saved) saved = getPlantType(user.uid);
        if (saved) {
          selectElem.value = saved;
          currCat = saved;
          updateAccountGauge(currPercent, currCat);
        }
      }, 10);

      const deleteBtn = card.querySelector(".deleteBtn");
      deleteBtn.addEventListener("click", async () => {
        const confirmed = await showConfirmModal("Biztosan t√∂rl√∂d ezt a fi√≥kot?");
        if (confirmed) {
          await signOut(auth);
          removeAccount(user.uid);
        }
      });

      selectElem.addEventListener("change", async (e) => {
        const value = e.target.value;
        currCat = value;
        setPlantType(user.uid, value);
        updateAccountGauge(currPercent, currCat);
        if (user.uid && firstDeviceId) {
          await set(ref(db, `users/${user.uid}/devices/${firstDeviceId}/plantType`), value);
        }
      });

      accountsContainer.appendChild(card);
      accounts.set(user.uid, { user, auth, card });
      if (!firstUser) firstUser = user;
    }
  </script>
  <script>
    const publicVapidKey = "BJ5EmlT4WDwHo9vyVZbROc4O2tkZlv5hBZVs8nbfEwJlJMdgpgEHnM9i5PugKAXYq10hbPjnvyLOBM-O3hi_Rhg";

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, "+")
        .replace(/_/g, "/");

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function subscribeUserToPush() {
      try {
        if (!window.jelenlegiEszkozID) {
          console.error("NINCS be√°ll√≠tva a k√©sz√ºl√©k ID! Nem lehet push-t regisztr√°lni.");
          return;
        }

        const registration = await navigator.serviceWorker.ready;

        // Megl√©v≈ë subscription lek√©r√©se
        let sub = await registration.pushManager.getSubscription();

        // Ha l√©tezik r√©gi √©s m√°s kulccsal j√∂tt l√©tre ‚Üí t√∂r√∂lj√ºk
        if (sub) {
          console.log("R√©gi push subscription tal√°lhat√≥, leiratkoz√°s...");
          await sub.unsubscribe();
          console.log("R√©gi subscription t√∂r√∂lve.");
        }

        // √öj feliratkoz√°s k√©sz√≠t√©se
        const newSub = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(
            "BJ5EmlT4WDwHo9vyVZbROc4O2tkZlv5hBZVs8nbfEwJlJMdgpgEHnM9i5PugKAXYq10hbPjnvyLOBM-O3hi_Rhg"
          )
        });

        console.log("√öj feliratkoz√°si token:", newSub);

        // Bek√ºld√©s a Netlify function fel√©
        await fetch("/.netlify/functions/DO_NOT_USE", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            subscription: newSub.toJSON(),
            deviceId: window.jelenlegiEszkozID   // <<< EZ MOST M√ÅR K√úLD≈êDIK
          })
        });

      } catch (err) {
        console.error("Push feliratkoz√°s hiba:", err);
      }
    }


    // biztosan el√©rhet≈ë legyen window.subscribeUserToPush n√©ven
    window.subscribeUserToPush = subscribeUserToPush;
  </script>



  

  <!-- OneSignal Web Push -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "6a595cdc-e443-4179-bc11-95241c8ad20f",
        notifyButton: { enable: false },
        allowLocalhostAsSecureOrigin: true
      });
    });
  </script>
<script>
    let notifEnabled = false;
    let jelenlegiKategoria = "";

    window.addEventListener('DOMContentLoaded', function(){
        const bellBtn = document.getElementById('notifBellBtn');
        const notifModal = document.getElementById('notifModal');
        const closeBtn = document.getElementById('notifModalClose');
        const yesBtn = document.getElementById('notifYes');
        const noBtn = document.getElementById('notifNo');

        function updateBellStyle(){
          if(notifEnabled){
            bellBtn.classList.remove("inactive");
          } else {
            bellBtn.classList.add("inactive");
          }
        }

        notifEnabled = localStorage.getItem('notifEnabled') === 'true';
        updateBellStyle();

        bellBtn.addEventListener('click', function(){
          notifModal.style.display = 'flex';
        });

        closeBtn.addEventListener('click', function(){
          notifModal.style.display = 'none';
        });

        yesBtn.addEventListener("click", async function(){
          notifEnabled = true;
          localStorage.setItem('notifEnabled', 'true');
          notifModal.style.display = 'none';
          updateBellStyle();

          // <<< V√ÅRJON, AM√çG NINCS k√©sz eszk√∂z ID >>>
          if (!window.jelenlegiEszkozID) {
            console.warn("V√°rakoz√°s eszk√∂z ID-re...");
            let tries = 0;
            while (!window.jelenlegiEszkozID && tries < 30) {
              await new Promise(r => setTimeout(r, 200));
              tries++;
            }
          }

          Notification.requestPermission().then(function(permission){
            if (permission === "granted") {
              window.subscribeUserToPush && window.subscribeUserToPush();
            }
          });
        });


        noBtn.addEventListener('click', async function(){
        notifEnabled = false;
        localStorage.setItem('notifEnabled', 'false');
        notifModal.style.display = 'none';
        updateBellStyle();

        const uid = window.currentUserUid;
        const deviceId = window.jelenlegiEszkozID;
        if (uid && deviceId) {
          try {
            await fetch(`https://plant-monitor-3976f-default-rtdb.europe-west1.firebasedatabase.app/users/${uid}/devices/${deviceId}/notifEnabled.json`, {
              method: "PUT",
              headers: {"Content-Type":"application/json"},
              body: "false"
            });
          } catch(e) {}
        }
      });

        window.addEventListener('click', function(e){
          if (e.target === notifModal) {
            notifModal.style.display = 'none';
          }
        });
)
            .catch(function(err) {
              console.log('Service Worker hiba:', err);
            });
        }

    });  <!-- *** EZ HI√ÅNYZOTT *** -->
  </script> <!-- *** EZ IS HI√ÅNYZOTT *** -->
</head>
<body>
  <h1>N√∂v√©nyfigyel≈ë üå±</h1>

  <div class="card" id="plantData">
    <form id="loginForm">
      <h3>Bejelentkez√©s</h3>
      <input type="email" id="email" placeholder="Email" required><br>
      <input type="password" id="password" placeholder="Jelsz√≥" required><br>
      <button type="submit">Bel√©p√©s</button>
    </form>
    <button id="logout">Kijelentkez√©s</button>
    <p id="status">Nincs bejelentkezve</p>
    <div class="gauge-container">
      <svg class="gauge-svg" width="220" height="220" viewBox="0 0 220 220">
        <circle class="gauge-bg" cx="110" cy="110" r="90"></circle>
        <circle class="gauge-fill" cx="110" cy="110" r="90"></circle>
      </svg>
      <div class="gauge-value" id="gauge-value">0%</div>
    </div>
  </div>

  <div id="accountsContainer"></div>

  <button id="addAccountBtn">+</button>

  <button id="notifBellBtn" aria-label="Push √©rtes√≠t√©s">
    <i class="fa-solid fa-bell"></i>
  </button>

  <div id="notifModal">
    <div id="notifModalContent">
      <span id="notifModalClose">&times;</span>
      <h3>Push √©rtes√≠t√©s be√°ll√≠t√°s</h3>
      <p>Szeretn√©l √©rtes√≠t√©st kapni, ha a n√∂v√©ny v√≠zszintje 35% al√° esik?</p>
      <div style="margin-top:28px;">
        <button id="notifYes" style="background:linear-gradient(145deg,#43a047,#66bb6a);color:#fff;border:none;border-radius:12px;padding:10px 20px;font-size:17px;cursor:pointer;margin:0 9px;">
          Igen
        </button>
        <button id="notifNo" style="background:#e0e8e5;color:#888;border:none;border-radius:12px;padding:10px 20px;font-size:17px;cursor:pointer;margin:0 9px;">
          Nem
        </button>
      </div>
    </div>
  </div>

  <div id="modal">
    <div id="modalContent">
      <span id="modalClose">&times;</span>
      <h3>Bejelentkez√©s</h3>
      <form id="addNewAccountForm">
        <input type="email" id="newAccountEmail" placeholder="Email"><br>
        <input type="password" id="newAccountPass" placeholder="Jelsz√≥"><br>
        <div style="text-align:center; margin: 10px 0; font-weight:600;">vagy</div>
        <input type="text" id="newAccountToken" placeholder="Azonos√≠t√≥"><br>
        <button type="submit">Bel√©p√©s</button>
      </form>
      <p id="addAccountStatus"></p>
    </div>
  </div>

  <div id="confirmModal">
    <div id="confirmModalContent">
      <span id="confirmClose">&times;</span>
      <h3 id="confirmText">Biztosan t√∂rl√∂d ezt a fi√≥kot?</h3>
      <div class="confirm-btn-group">
        <button class="confirm-btn confirm-igen" id="confirmIgenBtn">Igen</button>
        <button class="confirm-btn confirm-nem" id="confirmNemBtn">Nem</button>
      </div>
    </div>
  </div>
</body>
</html>